#! /usr/bin/env bash
# TODO - lots of this stuff should be global, make use of yadm globally

CURRENT_ZFS=$(pacman --color never -Q zfs-linux | cut -d\  -f 2)
CURRENT_KERNEL=$(uname -r)
# does installed kernel version match running kernel version?
if [[ "$( uname -r | tr "." "-" )" = "$( pacman -Q linux | cut  -d\  -f2 | tr "." "-")" ]]; then
    echo -e "yes:     $CURRENT_KERNEL (zfs $CURRENT_ZFS)"
else
    echo -e "no"
    echo -e "disk:    $(pacman -Q linux | cut  -d\  -f2)"
    echo -e "running: $CURRENT_KERNEL (zfs $CURRENT_ZFS)"
fi

BOOT_TIMESTAMP=$(/usr/bin/date --date "$(uptime --since)" +"%s")
RAMFS_TIMESTAMP=$(/usr/bin/stat --format="%Y" /boot/initramfs-linux.img)
KERNEL_TIMESTAMP=$(/usr/bin/stat --format="%Y" /boot/vmlinuz-linux)

if [[ $RAMFS_TIMESTAMP -ge $BOOT_TIMESTAMP ]]; then
    echo -e "(ramfs newer than boot time)"
fi

if [[ $KERNEL_TIMESTAMP -ge $BOOT_TIMESTAMP ]]; then
    echo -e "(kernel newer than boot time)"
fi

TMP_C="/tmp/kernel_cool.tmp"
if [[ -f "$TMP_C" && $(( $(/usr/bin/date +%s) - $(stat --format=%W "$TMP_C") )) -gt $(( 12*60*60 )) ]]; then
    rm "$TMP_C"
fi
if [[ ! -f "$TMP_C" ]]; then
    curl --silent 'https://archzfs.com/archzfs/x86_64/' \
        | hq a attr href \
        | sed --regexp-extended --silent \
        's/^zfs-linux-([0-9]+\.[0-9]+(\.[0-9]+)?)_([0-9]+\.[0-9]+\.([0-9]+)?.*)-x86_64.pkg.tar.zst$/openzfs: \3 (zfs \1)/gp' \
        | sed --regexp-extended --silent 's/-1\ \(/\ \(/gp' \
        >"$TMP_C"

    curl --silent 'https://geo.mirror.pkgbuild.com/core/os/x86_64/' \
        | hq a attr href \
        | sed --regexp-extended --silent \
        's/^linux-([0-9]+\.[0-9]+\.[0-9]+\.arch.*)-x86_64\.pkg\.tar\.zst$/kernel:  \1/gp' \
        >>"$TMP_C"
fi
cat "$TMP_C"

